<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Файловый менеджер - Админ панель</title>
    <link rel="stylesheet" type="text/css" href="/admin/templates/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
    --primary-color: #4285f4;
    --secondary-color: #fbbc05;
    --danger-color: #ea4335;
    --success-color: #34a853;
    --light-color: #f8f9fa;
    --dark-color: #202124;
    --border-color: #dadce0;
}

body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f5f5f5;
    color: var(--dark-color);
}

.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.admin-header h1 {
    margin: 0;
    color: var(--dark-color);
}

.current-path {
    font-size: 14px;
    color: #5f6368;
    margin-top: 5px;
}

.toolbar {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-secondary {
    background-color: var(--light-color);
    color: var(--dark-color);
    border: 1px solid var(--border-color);
}

.btn-danger {
    background-color: var(--danger-color);
    color: white;
}

.file-manager {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    overflow: hidden;
}

.file-table-header {
    background-color: var(--light-color);
    font-weight: 500;
    border-bottom: 1px solid var(--border-color);
}

.file-table-row {
    display: flex;
    padding: 12px 16px;
}

.file-name-col {
    flex: 1;
    min-width: 0;
}

.file-size-col {
    width: 120px;
}

.file-modified-col {
    width: 180px;
}

.file-actions-col {
    width: 200px;
}

.file-table-body .file-table-row {
    border-bottom: 1px solid var(--border-color);
}

.file-table-body .file-table-row:last-child {
    border-bottom: none;
}

.file-table-body .file-table-row:hover {
    background-color: #f8f9fa;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-icon {
    width: 20px;
    height: 20px;
}

.file-actions {
    display: flex;
    gap: 5px;
}

.file-action-btn {
    padding: 4px 8px;
    font-size: 13px;
    border-radius: 3px;
    border: none;
    cursor: pointer;
}

.file-action-btn.edit {
    background-color: var(--primary-color);
    color: white;
}

.file-action-btn.download {
    background-color: var(--success-color);
    color: white;
}

.file-action-btn.delete {
    background-color: var(--danger-color);
    color: white;
}

.status-bar {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 13px;
    color: #5f6368;
}

/* Модальные окна */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    width: 500px;
    max-width: 90%;
}

.modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 18px;
    font-weight: 500;
}

.modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #5f6368;
}

.modal-body {
    padding: 16px;
}

.modal-footer {
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.form-group {
    margin-bottom: 15px;
}

.form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-control {
    width: 95%;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
}

.textarea-code {
    font-family: 'Courier New', monospace;
    min-height: 150px;
    resize: vertical;
}
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Файловый менеджер</h1>
            <div class="current-path" id="currentPath">public/templates/</div>
        </header>

        <div class="toolbar">
            <button id="createFolder" class="btn btn-primary">
                <i class="fas fa-folder"></i> Новая папка
            </button>
            <button id="uploadFile" class="btn btn-primary">
                <i class="fas fa-upload"></i> Загрузить файл
            </button>
            <button id="refresh" class="btn btn-secondary">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
        </div>

        <div class="file-manager">
            <div class="file-table-header">
                <div class="file-table-row">
                    <div class="file-name-col">Имя</div>
                    <div class="file-size-col">Размер</div>
                    <div class="file-modified-col">Изменен</div>
                    <div class="file-actions-col">Действия</div>
                </div>
            </div>
            <div class="file-table-body" id="fileList">
                <!-- Сюда будет вставлен список файлов через JS -->
            </div>
        </div>

        <div class="status-bar">
            <span id="statusMessage">Готово</span>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="modalContainer"></div>

    <input type="file" id="fileInput" style="display: none;">

    <script>
        const currentPathElement = document.getElementById('currentPath');
        const fileListElement = document.getElementById('fileList');
        const storageInfoElement = document.getElementById('storageInfo');
        const modalContainer = document.getElementById('modalContainer');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('statusMessage');
        function setStatusMessage(message) {
            status.innerHTML = message;
        }

        let currentPath = 'public/templates/'; // Начальная директория
        
        document.getElementById('createFolder').addEventListener('click', createFolderModal);
        document.getElementById('uploadFile').addEventListener('click', () => fileInput.click());
        document.getElementById('refresh').addEventListener('click', loadFiles);

        fileInput.addEventListener('change', uploadFile);
        function updateCurrentPathDisplay() {
            currentPathElement.textContent = currentPath;
        }

        
        function loadFiles() {
            fetch(`/admin/api/files?path=${currentPath}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    renderFiles(data);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке файлов:', error);
                });
        }

        function renderFiles(files) {
            fileListElement.innerHTML = '';
            
            if (currentPath !== 'public/templates/') {
                const parentDirRow = document.createElement('div');
                parentDirRow.className = 'file-table-row';
                parentDirRow.innerHTML = `
                    <div class="file-name-col">
                        <div class="file-item">
                            <i class="fas fa-level-up-alt file-icon"></i>
                            <a href="#" onclick="navigate('..')">..</a>
                        </div>
                    </div>
                    <div class="file-size-col"></div>
                    <div class="file-modified-col"></div>
                    <div class="file-actions-col"></div>
                `;
                fileListElement.appendChild(parentDirRow);
            }

            files.forEach(file => {
                const fileRow = document.createElement('div');
                fileRow.className = 'file-table-row';

                const isDirectory = file.type === 'directory';
                const iconClass = isDirectory ? 'fa-folder' : 'fa-file';

                fileRow.innerHTML = `
                    <div class="file-name-col">
                        <div class="file-item">
                            <i class="fas ${iconClass} file-icon"></i>
                            ${isDirectory?`<a href="#" onclick="navigate('${file.name}')">${file.name}</a>`:`<b>${file.name}</b>`}
                        </div>
                    </div>
                    <div class="file-size-col">${isDirectory ? '-' : formatBytes(file.size)}</div>
                    <div class="file-modified-col">${file.modified}</div>
                    <div class="file-actions-col">
                        ${isDirectory ? '' : `<button class="file-action-btn edit" onclick="editFile('${currentPath}${file.name}')"><i class="fas fa-edit"></i></button>`}
                        ${isDirectory ? '' : `<button class="file-action-btn download" onclick="downloadFile('${currentPath}${file.name}')"><i class="fas fa-download"></i></button>`}
                        <button class="file-action-btn delete" onclick="deleteItem('${currentPath}${file.name}', '${file.type}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                fileListElement.appendChild(fileRow);
            });
        }

        function navigate(name) {
            if (name === '..') {
                // Переход на уровень выше
                const pathParts = currentPath.split('/').filter(part => part !== '');
                pathParts.pop();
                currentPath = pathParts.join('/') + '/';
            } else {
                // Переход в поддиректорию
                currentPath += name + '/';
            }

            updateCurrentPathDisplay();
            loadFiles();
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function createFolderModal() {
            const modal = createModal('Создать новую папку', `
                <div class="form-group">
                    <label for="folderName" class="form-label">Имя папки:</label>
                    <input type="text" class="form-control" id="folderName" placeholder="Введите имя папки">
                </div>
            `, 'Создать');

            modal.querySelector('button[type="submit"]').addEventListener('click', (e) => {
                e.preventDefault();
                const folderName = document.getElementById('folderName').value;
                if (folderName) {
                    createFolder(folderName);
                    closeModal();
                } else {
                    alert('Пожалуйста, введите имя папки.');
                }
            });
        }

        function createFolder(folderName) {
            fetch('/admin/api/createFolder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: currentPath,
                    name: folderName
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    setStatusMessage(`Папка "${folderName}" создана.`);
                    loadFiles();
                } else {
                    setStatusMessage(`Ошибка при создании папки: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Ошибка при создании папки:', error);
                setStatusMessage('Ошибка сети при создании папки.');
            });
        }

        function uploadFile() {
            console.log("Hello, honey!");
            const file = fileInput.files[0];
            if (!file) 
                return;

            fetch('/admin/api/uploadFile', { 
                method: 'POST',
                body: JSON.stringify({
                    file: file,
                    path: currentPath
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    setStatusMessage(`Файл "${file.name}" загружен.`);
                    loadFiles();
                } else {
                    setStatusMessage(`Ошибка при загрузке файла: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке файла:', error);
                setStatusMessage('Ошибка сети при загрузке файла.');
            });
        }

        function editFile(filePath) {
            fetch(`/admin/api/fileContent?path=${filePath}`) // Замените на ваш эндпоинт
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }
                    return response.text();
                })
                .then(content => {
                    const modal = createModal(`Редактирование: ${filePath.split('/').pop()}`, `
                        <div class="form-group">
                            <textarea class="form-control textarea-code" id="fileContent" rows="15">${content}</textarea>
                        </div>
                    `, 'Сохранить');

                    modal.querySelector('button[type="submit"]').addEventListener('click', (e) => {
                        e.preventDefault();
                        const newContent = document.getElementById('fileContent').value;
                        saveFile(filePath, newContent);
                        closeModal();
                    });
                })
                .catch(error => {
                    console.error('Ошибка при получении содержимого файла:', error);
                    setStatusMessage('Ошибка при получении содержимого файла.');
                });
        }

        function saveFile(filePath, content) {
            fetch('/admin/api/save', { // Замените на ваш эндпоинт
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: filePath,
                    content: content
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    setStatusMessage(`Файл "${filePath.split('/').pop()}" сохранен.`);
                    loadFiles();
                } else {
                    setStatusMessage(`Ошибка при сохранении файла: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении файла:', error);
                setStatusMessage('Ошибка сети при сохранении файла.');
            });
        }

        async function downloadFile(filePath) {
            try {
                // 1. Отправляем GET-запрос с path в URL (не в body!)
                const response = await fetch(`/admin/api/download?path=${encodeURIComponent(filePath)}`);
                
                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                // 2. Получаем файл как Blob
                const blob = await response.blob();
                
                // 3. Создаем временную ссылку для скачивания
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filePath.split('/').pop(); // Имя файла
                a.click();
                
                // 4. Освобождаем память
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                console.log('Файл скачивается');
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        function deleteItem(path, type) {
            const name = path.split('/').pop();
            const itemType = type === 'directory' ? 'папку' : 'файл';

            if (confirm(`Вы уверены, что хотите удалить ${itemType} "${name}"?`)) {
                fetch('/admin/api/delete', { // Замените на ваш эндпоинт
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: path,
                        type: type
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        setStatusMessage(`${type === 'directory' ? 'Папка' : 'Файл'} "${name}" удален.`);
                        loadFiles();
                    } else {
                        setStatusMessage(`Ошибка при удалении: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при удалении:', error);
                    setStatusMessage('Ошибка сети при удалении.');
                });
            }
        }

        
        function createModal(title, body, submitText) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-title">${title}</div>
                    <button class="modal-close">&times;</button>
                </div>
                <form class="modal-body">${body}</form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close">Отмена</button>
                    <button type="submit" class="btn btn-primary">${submitText}</button>
                </div>
            `;

            modalOverlay.appendChild(modalContent);
            modalContainer.appendChild(modalOverlay);

            
            modalOverlay.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            return modalContent;
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        
        window.onload = () => {
            updateCurrentPathDisplay();
            loadFiles();
        };
    </script>
    
</body>
</html>